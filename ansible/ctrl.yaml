---
- hosts: all
  become: yes
  vars:
    kube_user: "vagrant"
    ansible_user_home: "/home/vagrant"
  tasks:

    - name: Check if Kubernetes cluster is already initialized
      stat:
        path: /etc/kubernetes/admin.conf
      register: kubeconfig

    - name: Initialize Kubernetes cluster with kubeadm
      command: >
        kubeadm init
        --apiserver-advertise-address=192.168.56.100
        --node-name=ctrl
        --pod-network-cidr=10.244.0.0/16
        --ignore-preflight-errors=NumCPU
      when: not kubeconfig.stat.exists

    - name: Re-check for admin.conf after init
      stat:
        path: /etc/kubernetes/admin.conf
      register: kubeconfig_after

    - name: Ensure .kube directory exists for user
      file:
        path: "{{ ansible_user_home }}/.kube"
        state: directory
        owner: "{{ kube_user }}"
        group: "{{ kube_user }}"

# Step 14: Setup kubectl
    - name: Copy admin.conf so user can use kubectl
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "{{ ansible_user_home }}/.kube/config"
        remote_src: yes
        owner: "{{ kube_user }}"
        group: "{{ kube_user }}"
      when: kubeconfig_after.stat.exists

    - name: Copy admin.conf to host machine
      fetch:
        src: /etc/kubernetes/admin.conf
        dest: ./admin.conf
        flat: yes
      when: kubeconfig_after.stat.exists

# Step 15: Create Pod Network
    - name: Copy Flannel manifest to controller
      copy:
        src: kube-flannel.yml
        dest: "{{ ansible_user_home }}/kube-flannel.yml"
        owner: "{{ kube_user }}"
        group: "{{ kube_user }}"
        mode: '0644'

    - name: Apply Flannel manifest
      command: kubectl apply -f {{ ansible_user_home }}/kube-flannel.yml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

# For A2 - Excellent
    - name: Wait for core Kubernetes components to become ready (A2 Excellent)
      shell: |
        kubectl wait --for=condition=ready pod -l k8s-app=kube-dns -n kube-system --timeout=120s
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      retries: 5
      delay: 10

# Step 16: Install Helm
    - name: Install required packages for Helm
      apt:
        name:
          - curl
          - gpg
          - apt-transport-https
        state: present
        update_cache: yes

    - name: Download Helm GPG key and dearmor it
      shell: |
        curl -fsSL https://packages.buildkite.com/helm-linux/helm-debian/gpgkey \
        | gpg --dearmor \
        | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
      args:
        executable: /bin/bash

    - name: Add Helm APT repository
      copy:
        dest: /etc/apt/sources.list.d/helm-stable-debian.list
        content: |
          deb [signed-by=/usr/share/keyrings/helm.gpg] https://packages.buildkite.com/helm-linux/helm-debian/any/ any main

    - name: Update apt 
      apt:
        update_cache: yes

    - name: Install Helm
      apt:
        name: helm
        state: present

# Step 17: Install Helm package
    - name: Check if helm-diff is already installed
      become_user: "{{ kube_user }}"
      command: helm plugin list
      register: helm_plugins
      changed_when: false

    - name: Install helm-diff plugin
      become_user: "{{ kube_user }}"
      command: helm plugin install https://github.com/databus23/helm-diff
      when: "'diff' not in helm_plugins.stdout"
      ignore_errors: yes